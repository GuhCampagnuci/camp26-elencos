<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CAMP 2026 ‚Äî Elencos</title>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a2a;
      --text:#e7eefc;
      --muted:#9bb0d1;
      --line:#22314f;
      --accent:#7c5cff;
      --danger:#ff5c7a;
      --ok:#4ade80;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(124,92,255,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding-bottom: 84px;
    }
    a{ color: inherit; text-decoration:none; }

    header{
      position: sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,15,23,.65);
      border-bottom:1px solid rgba(34,49,79,.65);
    }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 14px; }

    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{
      font-weight: 900; letter-spacing:.4px;
      font-size: 16px;
    }
    .api{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      border:1px solid rgba(34,49,79,.85);
      background: rgba(9,12,18,.55);
      font-size: 12px; font-weight: 800; color: var(--muted);
      white-space: nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: var(--muted); }

    .card{
      background: linear-gradient(180deg, rgba(18,26,42,.92), rgba(15,22,38,.92));
      border:1px solid rgba(34,49,79,.75);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .bd{ padding: 14px; }

    .state{
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border:1px solid rgba(34,49,79,.75);
      background: rgba(9,12,18,.40);
      color: var(--muted);
      font-size: 13px;
      white-space: pre-wrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top: 12px;
    }
    @media (min-width: 840px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .team{
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(34,49,79,.75);
      background: rgba(9,12,18,.35);
      display:grid;
      gap:10px;
    }
    .teamHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .teamName{
      font-weight: 1000;
      letter-spacing:.4px;
      font-size: 14px;
      text-transform: uppercase;
    }
    .meta{
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
    }
    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 1000;
      background: rgba(124,92,255,.15);
      border: 1px solid rgba(124,92,255,.35);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .btn.open{
      background: rgba(255,255,255,.06);
      border-color: rgba(34,49,79,.75);
      color: var(--muted);
    }

    .groups{
      display:none;
      border-top: 1px solid rgba(34,49,79,.6);
      padding-top: 10px;
    }
    .team.open .groups{ display:block; }

    .group{
      margin-top: 10px;
      border: 1px solid rgba(34,49,79,.65);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(9,12,18,.25);
    }
    .groupHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(34,49,79,.5);
      background: rgba(9,12,18,.35);
    }
    .groupLabel{
      font-weight: 1000;
      font-size: 12px;
      letter-spacing:.3px;
      color: var(--text);
    }
    .count{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(124,92,255,.15);
      border: 1px solid rgba(124,92,255,.25);
      font-weight: 900;
      color: var(--text);
      white-space: nowrap;
    }
    .players{ padding: 8px 10px; }

    .player{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 8px 6px;
      border-bottom: 1px dashed rgba(34,49,79,.55);
      font-size: 13px;
    }
    .player:last-child{ border-bottom:none; }

    .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .name{
      font-weight: 900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 220px;
    }
    .pos{
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 10px;
      background: rgba(9,12,18,.35);
      border: 1px solid rgba(34,49,79,.75);
      font-weight: 900;
      color: var(--muted);
      white-space: nowrap;
    }
    .ovr{
      min-width: 46px;
      text-align:center;
      font-weight: 1000;
      border-radius: 10px;
      padding: 3px 8px;
      background: rgba(124,92,255,.15);
      border: 1px solid rgba(124,92,255,.30);
      color: var(--text);
      white-space: nowrap;
    }

    nav.mobileNav{
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 74px;
      background: rgba(11,15,23,.85);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(34,49,79,.6);
      z-index: 50;
    }
    .navWrap{
      max-width: 1100px;
      margin: 0 auto;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      padding: 8px 8px;
    }
    .navItem{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding: 6px 6px;
      border-radius: 14px;
      border: 1px solid transparent;
      color: var(--muted);
      font-size: 10px;
      user-select:none;
    }
    .navItem .ico{ font-size: 16px; }
    .navItem.active{
      color: var(--text);
      border-color: rgba(124,92,255,.35);
      background: rgba(124,92,255,.10);
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="title">ELENCOS</div>
        <div class="api"><span class="dot" id="apiDot"></span><span id="apiTxt">API</span></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="bd">
        <div id="state" class="state">Carregando elencos‚Ä¶</div>
        <div id="grid" class="grid" style="display:none;"></div>
      </div>
    </div>
  </main>

  <nav class="mobileNav" aria-label="Menu">
    <div class="navWrap">
      <a class="navItem" href="index.html" title="In√≠cio"><div class="ico">üè†</div><div>In√≠cio</div></a>
      <a class="navItem active" href="elencos.html" title="Elencos"><div class="ico">üßë‚Äçü§ù‚Äçüßë</div><div>Elencos</div></a>
      <a class="navItem" href="disponibilidade.html" title="Disponibilidade"><div class="ico">üìÖ</div><div>Disp.</div></a>
      <a class="navItem" href="desafios.html" title="Desafios"><div class="ico">‚öîÔ∏è</div><div>Desafios</div></a>
      <a class="navItem" href="reportar_partida.html" title="Reportar partida"><div class="ico">üìù</div><div>Reportar</div></a>
      <a class="navItem" href="estatisticas.html" title="Estat√≠sticas"><div class="ico">üìä</div><div>Stats</div></a>
      <a class="navItem" href="regras.html" title="Regras"><div class="ico">üìú</div><div>Regras</div></a>
    </div>
  </nav>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbyi1AWCya8OjxVMVWt7JT3CqivvwgKzzRZeH3UQgzQ0Iik3-zTqvgChddwmuKm0E0JLLA/exec";

    const apiDot = document.getElementById("apiDot");
    const apiTxt = document.getElementById("apiTxt");
    const state = document.getElementById("state");
    const grid = document.getElementById("grid");

    function setApi(ok){
      apiDot.style.background = ok ? "var(--ok)" : "var(--danger)";
      apiTxt.textContent = ok ? "API OK" : "API OFF";
      apiTxt.style.color = ok ? "var(--ok)" : "var(--danger)";
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function jsonp(route, params = {}) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const url = new URL(API_BASE);
        url.searchParams.set("route", route);
        url.searchParams.set("callback", cb);
        url.searchParams.set("_ts", Date.now());

        Object.entries(params).forEach(([k,v]) => {
          if (v !== undefined && v !== null && String(v).trim() !== "") url.searchParams.set(k, v);
        });

        const s = document.createElement("script");
        s.src = url.toString();
        s.async = true;

        const t = setTimeout(() => { cleanup(); reject(new Error("timeout")); }, 12000);

        function cleanup(){
          clearTimeout(t);
          if(s.parentNode) s.parentNode.removeChild(s);
          try{ delete window[cb]; }catch(_){ window[cb] = undefined; }
        }

        window[cb] = (data) => { cleanup(); resolve(data); };
        s.onerror = () => { cleanup(); reject(new Error("load_failed")); };
        document.head.appendChild(s);
      });
    }

    // ==========================================================
    // ‚úÖ CORRIGIDO: reconhece posi√ß√µes compostas "ATA/PE/MEI"
    // ==========================================================
    function splitPosTokens(posRaw){
      // posRaw pode vir como string "ATA/PE/MEI" ou como array ["ATA","PE","MEI"]
      if (Array.isArray(posRaw)) {
        return posRaw.map(x => String(x || "").toUpperCase().trim()).filter(Boolean);
      }
      const raw = String(posRaw || "").toUpperCase().trim();
      if (!raw) return [];
      return raw
        .split("/")                  // quebra "ATA/PE/MEI"
        .map(x => x.trim())
        .filter(Boolean);
    }

    function hasAny(tokens, arr){
      const set = new Set(tokens);
      return arr.some(x => set.has(x));
    }

    function posBucket(posRaw){
      const tokens = splitPosTokens(posRaw);

      // 1) Goleiros
      if (hasAny(tokens, ["GOL","GK"])) return "Goleiros";

      // 2) Defensores
      if (hasAny(tokens, ["ZAG","CB","LE","LB","LD","RB","ALA","LWB","RWB","LAT"])) return "Defensores";

      // 3) Meios campistas (inclui MEI)
      if (hasAny(tokens, ["VOL","CDM","MC","CM","ME","LM","MD","RM","MEI","CAM","MA","SA"])) return "Meios campistas";

      // 4) Atacantes (inclui PE/PD/ATA)
      if (hasAny(tokens, ["ATA","ST","CA","CF","PE","LW","PD","RW"])) return "Atacantes";

      return "Outros";
    }

    function buildGroupedTeam(team){
      const name = String(team.name || "").toUpperCase().trim();

      const rawItems = Array.isArray(team.jogadores) ? team.jogadores : [];

      const bucketsOrder = ["Goleiros","Defensores","Meios campistas","Atacantes","Outros"];
      const buckets = {};
      bucketsOrder.forEach(b => buckets[b] = []);

      rawItems.forEach(p => {
        const bucket = posBucket(p.positions);
        buckets[bucket].push(p);
      });

      // ordena por overall desc dentro de cada grupo
      bucketsOrder.forEach(b => {
        buckets[b].sort((a,b2) => Number(b2.overall||0) - Number(a.overall||0));
      });

      const groups = bucketsOrder
        .filter(b => buckets[b].length > 0)
        .map(b => ({ label: b, items: buckets[b] }));

      const total = rawItems.length;

      return { name, total, groups };
    }

    function teamCard(team){
      const normalized = buildGroupedTeam(team);

      const groupsHtml = normalized.groups.map(g => {
        const label = String(g.label || "ELENCO").toUpperCase();
        const items = Array.isArray(g.items) ? g.items : [];

        const playersHtml = items.map(p => `
          <div class="player">
            <div class="left">
              <span class="name" title="${esc(p.name)}">${esc(p.name)}</span>
              <span class="pos" title="Posi√ß√£o">${esc(Array.isArray(p.positions) ? p.positions.join("/") : String(p.positions || "-"))}</span>
            </div>
            <span class="ovr">${esc(p.overall ?? "‚Äî")}</span>
          </div>
        `).join("");

        return `
          <div class="group">
            <div class="groupHead">
              <span class="groupLabel">${esc(label)}</span>
              <span class="count">${items.length}</span>
            </div>
            <div class="players">${playersHtml}</div>
          </div>
        `;
      }).join("");

      return `
        <div class="team">
          <div class="teamHead">
            <div>
              <div class="teamName">${esc(normalized.name)}</div>
              <div class="meta">${esc(normalized.total)} jogadores</div>
            </div>
            <button class="btn" type="button">Ver elenco</button>
          </div>
          <div class="groups">${groupsHtml || `<div class="state">Sem jogadores</div>`}</div>
        </div>
      `;
    }

    function attachToggles(){
      document.querySelectorAll(".team .btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".team");
          const open = card.classList.toggle("open");
          btn.textContent = open ? "Fechar" : "Ver elenco";
          btn.classList.toggle("open", open);
        });
      });
    }

    async function load(){
      state.style.display = "block";
      grid.style.display = "none";
      state.textContent = "Carregando elencos‚Ä¶";

      try{
        const r = await jsonp("elencos");
        setApi(true);

        if (!r || !r.ok) {
          state.textContent = "‚ö†Ô∏è A API respondeu, mas n√£o trouxe elencos.\n\nDetalhe: " + (r && r.error ? r.error : "Resposta inv√°lida");
          return;
        }
        const teamsArr = Array.isArray(r.teams) ? r.teams : (Array.isArray(r.elencos) ? r.elencos : null);
        if (!teamsArr) {
          state.textContent = "‚ö†Ô∏è JSON inesperado.\n\nRecebi:\n" + JSON.stringify(r, null, 2);
          return;
        }

        const teams = teamsArr.slice().sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "pt-BR"));
        grid.innerHTML = teams.map(teamCard).join("");
        attachToggles();

        state.style.display = "none";
        grid.style.display = "grid";
      }catch(err){
        setApi(false);
        state.textContent =
          "‚ùå API OFF.\n\n" +
          "Erro: " + (err && err.message ? err.message : String(err));
      }
    }

    load();
  </script>
</body>
</html>
